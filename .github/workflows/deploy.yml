name: ðŸš€ New Deploy Script
on:
  push:
    paths:
      - 'site/images/**'
  pull_request:
      
jobs:
  compress:
    name: ðŸ—œï¸ Compress Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - uses: namoscato/action-tinify@v1
        with:
          api_key: ${{ secrets.TINIFY_API_KEY }}
          commit_message: 'TinyPNG Compression Active'
  web-deploy:
    name: ðŸŽ‰ Deploy
    needs: compress
    runs-on: ubuntu-latest
    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v3
    
    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ftp.bgsandbox.com
        username: developer@bgsandbox.com
        password: ${{ secrets.ftp_password }}
        port: 21
        local-dir: ./site/
        server-dir: /public_html/tinypng-test/
        exclude: |
          **/.DS_Store
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/assets/sass/**
          **/uswds/img/material-icons-deprecated/**
          **/uswds/img/material-icons/*
  changed_files:
    runs-on: ubuntu-latest  # windows-latest || macos-latest
    name: Test changed-files
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v42

      - name: List all changed files
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          for file in "$ALL_CHANGED_FILES"; do
            echo "$file was changed"
          done          
  lighthouse:
    name: ðŸ‘€ Lighthouse Scan
    runs-on: ubuntu-latest
    needs: web-deploy
    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@master
    - name: ðŸ‘€ Lighthouse
      uses: foo-software/lighthouse-check-action@master
      with:
        urls: 'https://bgsandbox.com/tinypng-test/index.html,https://bgsandbox.com/tinypng-test/test.html'
        device: all
        gitAuthor: ${{ github.actor }}
        gitBranch: ${{ github.ref }}
        gitHubAccessToken: ${{ secrets.GITHUB_TOKEN }}
        sha: ${{ github.sha }}
        slackWebhookUrl: ${{ secrets.LIGHTHOUSE_CHECK_WEBHOOK_URL }}
